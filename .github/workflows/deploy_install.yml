name: (2/2) Deploy Laravel - Setup & Run

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: SSH to Server & Deploy Laravel
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WEBGLOBE_SSH_HOST }}
          username: ${{ secrets.WEBGLOBE_SSH_USER }}
          password: ${{ secrets.WEBGLOBE_SSH_PASSWORD }}
          port: ${{ secrets.WEBGLOBE_SSH_PORT }}
          script: |
            bash -c '
            cd public_html/beer_quiz

            echo "ğŸš€ SpouÅ¡tÃ­m nasazenÃ­ Laravel aplikace..."

            # 1ï¸âƒ£ Kontrola existence .env souboru
            if [ ! -f .env ]; then
              echo "âŒ ChybÃ­ .env soubor! Zastavuji nasazenÃ­."
              exit 1
            fi
            echo "âœ… .env soubor nalezen, pokraÄuji..."

            # 2ï¸âƒ£ Instalace PHP balÃ­ÄkÅ¯ (Composer)
            echo "ğŸ“¦ Instalace PHP balÃ­ÄkÅ¯..."
            if [ ! -d vendor ]; then
              /usr/bin/php8.3 /usr/bin/composer install --no-dev --optimize-autoloader
            else
              /usr/bin/php8.3 /usr/bin/composer update --no-dev --optimize-autoloader
            fi
            
            # 3ï¸âƒ£ Instalace JS balÃ­ÄkÅ¯ a build (NPM)
            if [ -f package.json ]; then
              echo "ğŸ“¦ Instalace JS balÃ­ÄkÅ¯..."
              npm install
              echo "ğŸ”§ Build frontend..."
              npm run build
            else
              echo "âš ï¸ package.json nenalezen, pÅ™eskoÄeno."
            fi

            # 4ï¸âƒ£ Migrace databÃ¡ze
            echo "ğŸ“Š SpouÅ¡tÄ›nÃ­ migracÃ­..."
            /usr/bin/php8.3 artisan migrate --force

            # 5ï¸âƒ£ Cache & optimalizace
            echo "ğŸš€ Nastavuji cache a optimalizaci..."
            /usr/bin/php8.3 artisan config:cache
            /usr/bin/php8.3 artisan route:cache
            /usr/bin/php8.3 artisan view:cache

            # 6ï¸âƒ£ Storage link
            echo "ğŸ”— VytvÃ¡Å™Ã­m storage link..."
            /usr/bin/php8.3 artisan storage:link

            echo "âœ… Laravel aplikace byla ÃºspÄ›Å¡nÄ› nasazena!"
            '
